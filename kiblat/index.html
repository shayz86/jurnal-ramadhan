<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kiblat ‚Äî NoorRahma</title>

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#0f172a;
 color:white;
}

header{
 display:flex;
 align-items:center;
 gap:10px;
 padding:14px;
 background:#064e3b;
}

header button{
 background:none;
 border:none;
 color:white;
 font-size:20px;
}

.container{
 padding:16px;
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:14px;
}

.card{
 background:#020617;
 border-radius:18px;
 padding:20px;
 text-align:center;
 cursor:pointer;
 border:1px solid #1e293b;
}

.card h3{margin:10px 0 0;font-size:15px}

.full{
 grid-column:1/3;
}

#compassWrap{
 margin-top:20px;
 text-align:center;
}

.circle{
 width:260px;
 height:260px;
 border-radius:50%;
 border:4px solid #10b981;
 margin:auto;
 position:relative;
}

.arrow{
 position:absolute;
 top:50%;
 left:50%;
 width:6px;
 height:110px;
 background:#ef4444;
 transform-origin:bottom center;
 translate:-50% -100%;
 border-radius:4px;
}

.status{
 margin-top:10px;
 font-size:13px;
 opacity:.8;
}

.hidden{display:none}

.btn{
 background:#10b981;
 color:black;
 border:none;
 padding:10px 16px;
 border-radius:14px;
 font-weight:600;
 margin-top:10px;
 width:90%;
}
</style>
</head>
<body>

<header>
<button onclick="history.back()">‚Üê</button>
<h2>Kiblat</h2>
</header>

<div class="container">

<div class="card" onclick="openCompass()">
üß≠
<h3>Kompas</h3>
</div>

<div class="card" onclick="location.href='/kiblat-ar/'">
üì∑
<h3>AR Camera</h3>
</div>

<div class="card full" onclick="openCalibrate()">
üåÄ
<h3>Kalibrasi Sensor</h3>
</div>

</div>

<!-- ================= COMPASS ================= -->

<div id="compassWrap" class="hidden">

<div class="circle">
 <div id="arrow" class="arrow"></div>
</div>

<div id="degTxt" class="status">0¬∞</div>
<div id="gpsTxt" class="status">GPS: ...</div>
<div id="sensorTxt" class="status">Sensor: ...</div>

<button class="btn" onclick="openGoogleQibla()">
üåç Gunakan Google Qibla Finder
</button>

<button class="btn" onclick="stopCompass()">Tutup</button>

</div>

<!-- ================= KALIBRASI ================= -->

<div id="calibWrap" class="hidden" style="padding:20px;text-align:center">

<h3>Kalibrasi Kompas</h3>
<p>Putar HP membentuk angka 8 selama 10 detik.</p>
<p>Jauhkan dari benda logam / magnet.</p>

<button class="btn" onclick="closeCalibrate()">Selesai</button>

</div>

<script>
/* ================= PRO GUARD ================= */

if(localStorage.getItem("nr_is_pro")!=="1"){
 alert("Fitur PRO üîí");
 location.href="/";
}

/* ================= KIBLAT LOGIC ================= */

const kaaba={lat:21.4225,lon:39.8262};

function bearing(lat1,lon1,lat2,lon2){
 const œÜ1=lat1*Math.PI/180;
 const œÜ2=lat2*Math.PI/180;
 const dŒª=(lon2-lon1)*Math.PI/180;

 return (Math.atan2(
  Math.sin(dŒª),
  Math.cos(œÜ1)*Math.tan(œÜ2)-Math.sin(œÜ1)*Math.cos(dŒª)
 )*180/Math.PI+360)%360;
}

let qibla=0;
let lastAngle=null;

const arrow=document.getElementById("arrow");
const degTxt=document.getElementById("degTxt");
const gpsTxt=document.getElementById("gpsTxt");
const sensorTxt=document.getElementById("sensorTxt");

function smoothAngle(target){
 if(lastAngle===null){
  lastAngle=target;
  return target;
 }
 let delta=((target-lastAngle+540)%360)-180;
 lastAngle=(lastAngle+delta*0.12+360)%360;
 return lastAngle;
}

function openCompass(){
 document.querySelector(".container").classList.add("hidden");
 document.getElementById("compassWrap").classList.remove("hidden");

 navigator.geolocation.getCurrentPosition(pos=>{
  qibla=bearing(
   pos.coords.latitude,
   pos.coords.longitude,
   kaaba.lat,
   kaaba.lon
  );
  gpsTxt.textContent="GPS: OK";
 });

 window.addEventListener("deviceorientationabsolute",handleOri,true);
 window.addEventListener("deviceorientation",handleOri,true);
}

function handleOri(e){
 let heading=null;

 if(e.webkitCompassHeading){
  heading=e.webkitCompassHeading;
 }else if(e.alpha!==null){
  heading=360-e.alpha;
 }

 if(!heading)return;

 const raw=(qibla-heading+360)%360;
 const smooth=smoothAngle(raw);

 arrow.style.transform=`rotate(${smooth}deg)`;
 degTxt.textContent=Math.round(smooth)+"¬∞";

 sensorTxt.textContent="Sensor: OK";

 if(lastAngle && Math.abs(lastAngle - smooth) > 25){
  sensorTxt.textContent="Sensor: Tidak stabil ‚ö†Ô∏è";
 }
}

function stopCompass(){
 location.reload();
}

/* ================= GOOGLE QIBLA ================= */

function openGoogleQibla(){
 window.open(
  "https://qiblafinder.withgoogle.com/",
  "_blank"
 );
}

/* ================= KALIBRASI ================= */

function openCalibrate(){
 document.querySelector(".container").classList.add("hidden");
 document.getElementById("calibWrap").classList.remove("hidden");
}

function closeCalibrate(){
 location.reload();
}
</script>

</body>
</html>
