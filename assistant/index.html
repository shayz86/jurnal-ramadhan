<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Smart Assistant â€” NoorRahma PRO</title>

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config={
 darkMode:"class",
 theme:{extend:{}}
}
</script>

<style>
body{font-family:system-ui}
.chat-scroll::-webkit-scrollbar{display:none}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950">

<!-- ================= PRO GUARD ================= -->

<script>
if(localStorage.getItem("nr_is_pro")!=="1"){
 alert("ğŸ”’ Fitur khusus akun PRO");
 location.href="/";
}
</script>

<!-- ================= APP ================= -->

<header class="sticky top-0 z-20 bg-emerald-700 text-white p-3 flex items-center gap-3">
<button onclick="history.back()">â†</button>
<h2 class="font-bold">Smart Islamic Assistant</h2>
</header>

<main id="messages"
 class="h-[calc(100vh-140px)] overflow-y-auto p-4 space-y-4 chat-scroll">
</main>

<!-- ================= INPUT ================= -->

<footer class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-3">

<div class="flex gap-2 max-w-md mx-auto">

<input
 id="msgInput"
 type="text"
 placeholder="Tanya tentang ibadah, fiqh, puasa..."
 class="flex-1 border rounded-xl px-4 py-3 text-sm focus:outline-emerald-500"
/>

<button
 onclick="sendMsg()"
 id="sendBtn"
 class="bg-emerald-600 text-white px-5 py-3 rounded-xl font-bold">
Kirim
</button>

<button
 onclick="stopAI()"
 id="stopBtn"
 class="hidden bg-red-500 text-white px-4 py-3 rounded-xl font-bold">
Stop
</button>

</div>
</footer>

<!-- ================= SCRIPT ================= -->

<script>

const messages=document.getElementById("messages");
const input=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const stopBtn=document.getElementById("stopBtn");

/* ===== HISTORY ===== */

let history=JSON.parse(
 localStorage.getItem("nr_assistant_history")||"[]"
);

history.forEach(addBubble);

/* ===== STREAM CTRL ===== */

let controller=null;

/* ===== UI ===== */

function addBubble(msg){

 const div=document.createElement("div");
 div.className=
  (msg.from==="user"
   ?"ml-auto bg-emerald-600 text-white"
   :"mr-auto bg-white dark:bg-slate-800")
  +" max-w-[80%] p-3 rounded-2xl shadow";

 div.innerText=msg.text;

 messages.appendChild(div);
 messages.scrollTop=messages.scrollHeight;
}

function addTyping(){
 const t=document.createElement("div");
 t.id="typing";
 t.className="mr-auto bg-slate-200 dark:bg-slate-700 p-3 rounded-2xl w-24 animate-pulse";
 messages.appendChild(t);
 messages.scrollTop=messages.scrollHeight;
}

function hideTyping(){
 const t=document.getElementById("typing");
 if(t)t.remove();
}

/* ===== SEND ===== */

function sendMsg(){

 const text=input.value.trim();
 if(!text)return;

 const obj={from:"user",text,time:Date.now()};
 history.push(obj);
 localStorage.setItem("nr_assistant_history",JSON.stringify(history));

 addBubble(obj);

 input.value="";

 sendToAI(text);
}

/* ===== AI STREAM ===== */

async function sendToAI(text){

 hideTyping();
 addTyping();

 controller=new AbortController();

 stopBtn.classList.remove("hidden");

 const bubble=document.createElement("div");
 bubble.className=
  "mr-auto bg-white dark:bg-slate-800 max-w-[80%] p-3 rounded-2xl shadow";

 const body=document.createElement("div");

 bubble.appendChild(body);

 messages.appendChild(bubble);
 messages.scrollTop=messages.scrollHeight;

 try{

  const res=await fetch("/api/assistant",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({prompt:text}),
   signal:controller.signal
  });

  hideTyping();

  const reader=res.body.getReader();
  const decoder=new TextDecoder();

  let final="";

  while(true){

   const {value,done}=await reader.read();
   if(done)break;

   const chunk=decoder.decode(value);
   final+=chunk;

   body.innerText=final;
   messages.scrollTop=messages.scrollHeight;
  }

  history.push({from:"bot",text:final,time:Date.now()});
  localStorage.setItem("nr_assistant_history",JSON.stringify(history));

 }catch(e){

  hideTyping();
  body.innerText="âš ï¸ Gagal terhubung ke server AI.";

 }

 stopBtn.classList.add("hidden");
 controller=null;
}

/* ===== STOP ===== */

function stopAI(){
 if(controller){
  controller.abort();
  controller=null;
 }
 stopBtn.classList.add("hidden");
}

/* ENTER SEND */

input.addEventListener("keydown",e=>{
 if(e.key==="Enter")sendMsg();
});

</script>

</body>
</html>
