<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Smart Assistant â€” NoorRahma PRO</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={darkMode:"class"}
</script>

<style>
body{font-family:system-ui}
.chat-scroll::-webkit-scrollbar{display:none}
.ref-box{background:#ecfdf5;border-left:4px solid #10b981}
.dark .ref-box{background:#022c22}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950">

<!-- ===== PRO GUARD ===== -->
<script>
if(localStorage.getItem("nr_is_pro")!=="1"){
 alert("ğŸ”’ Fitur khusus akun PRO");
 location.href="/";
}
</script>

<header class="sticky top-0 bg-emerald-700 text-white p-3 flex items-center gap-3">
<button onclick="history.back()">â†</button>
<h2 class="font-bold">Smart Islamic Assistant</h2>
</header>

<!-- ================= ENTRY SCREEN ================= -->

<div id="entryScreen"
 class="p-6 space-y-5 text-center">

<h3 class="font-bold text-lg">ğŸ¤– Smart Assistant</h3>

<button onclick="resumeChat()"
 class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">
Lanjut Chat Terakhir
</button>

<button onclick="newChat()"
 class="w-full bg-slate-200 py-3 rounded-xl font-bold">
Chat Baru
</button>

</div>

<!-- ================= CHAT UI ================= -->

<div id="chatUI" class="hidden">

<main id="messages"
 class="h-[calc(100vh-220px)] overflow-y-auto p-4 space-y-4 chat-scroll">
</main>

<div class="px-3 py-2 flex gap-2 overflow-x-auto text-xs bg-white dark:bg-slate-900">
 <button class="chip">ğŸ•Œ Waktu shalat</button>
 <button class="chip">ğŸ¤² Doa harian</button>
 <button class="chip">ğŸŒ™ Puasa sunnah</button>
 <button class="chip">ğŸ“– Tafsir ayat</button>
</div>

<footer class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-3">

<div class="flex gap-2 max-w-md mx-auto">

<button id="micBtn"
 onclick="startVoice()"
 class="bg-slate-200 px-3 py-3 rounded-xl">ğŸ™</button>

<input id="msgInput"
 placeholder="Tanya tentang ibadah..."
 class="flex-1 border rounded-xl px-4 py-3 text-sm"/>

<button onclick="sendMsg()"
 class="bg-emerald-600 text-white px-5 py-3 rounded-xl font-bold">
Kirim
</button>

<button onclick="stopAI()"
 id="stopBtn"
 class="hidden bg-red-500 text-white px-4 py-3 rounded-xl font-bold">
Stop
</button>

</div>
</footer>

</div>

<script>
/* ===================== */

const messages=document.getElementById("messages");
const input=document.getElementById("msgInput");
const stopBtn=document.getElementById("stopBtn");

const entryScreen=document.getElementById("entryScreen");
const chatUI=document.getElementById("chatUI");

/* ===== CHAT CONTROL ===== */

function resumeChat(){
 entryScreen.classList.add("hidden");
 chatUI.classList.remove("hidden");
 history.forEach(addBubble);
}

function newChat(){
 if(confirm("Mulai chat baru?")){
  history=[];
  localStorage.removeItem("nr_assistant_history");
  messages.innerHTML="";
  resumeChat();
 }
}

/* ===== HISTORY ===== */

let history=JSON.parse(
 localStorage.getItem("nr_assistant_history")||"[]"
);

/* ===== VOICE LOCK ===== */

let voiceActive=false;
let speaking=false;

/* ===== OFFLINE FAQ ===== */

const offlineFAQ=[
 {k:"shalat",v:"Shalat wajib lima waktu: Subuh, Dzuhur, Ashar, Maghrib, Isya."},
 {k:"wudhu",v:"Wudhu: niat, basuh wajah, tangan, usap kepala, kaki, tertib."},
 {k:"puasa",v:"Puasa Ramadhan wajib bagi muslim baligh dan mampu."},
];

/* ===================== */

function addBubble(msg){

 const div=document.createElement("div");
 div.className=
  (msg.from==="user"
   ?"ml-auto bg-emerald-600 text-white"
   :"mr-auto bg-white dark:bg-slate-800")
  +" max-w-[80%] p-3 rounded-2xl shadow relative";

 div.innerHTML=`<div>${msg.text}</div>`;

 if(msg.from==="bot"){

  const speak=document.createElement("button");
  speak.innerText="ğŸ”Š";
  speak.className="absolute bottom-1 right-2 text-xs opacity-60";

  speak.onclick=()=>{

   if(speaking)return;

   speaking=true;
   voiceActive=false;

   const u=new SpeechSynthesisUtterance(msg.text);
   u.lang="id-ID";

   u.onend=()=>speaking=false;

   speechSynthesis.speak(u);
  };

  div.appendChild(speak);
 }

 messages.appendChild(div);
 messages.scrollTop=messages.scrollHeight;
}

/* ===== SEND ===== */

function sendMsg(){

 const text=input.value.trim();
 if(!text)return;

 const obj={from:"user",text};
 history.push(obj);
 localStorage.setItem("nr_assistant_history",JSON.stringify(history));
 addBubble(obj);
 input.value="";

 sendToAI(text);
}

/* ===== AI ===== */

async function sendToAI(text){

 const faq=offlineFAQ.find(f=>text.toLowerCase().includes(f.k));
 if(!navigator.onLine && faq){
  addBubble({from:"bot",text:faq.v});
  return;
 }

 stopBtn.classList.remove("hidden");

 const bubble=document.createElement("div");
 bubble.className="mr-auto bg-white dark:bg-slate-800 max-w-[80%] p-3 rounded-2xl shadow";

 const body=document.createElement("div");
 bubble.appendChild(body);
 messages.appendChild(bubble);

 try{

  const res=await fetch("/api/assistant",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({prompt:text})
  });

  const reader=res.body.getReader();
  const decoder=new TextDecoder();

  let final="";

  while(true){
   const {value,done}=await reader.read();
   if(done)break;

   const chunk=decoder.decode(value);
   final+=chunk;
   body.innerText=final;
  }

  history.push({from:"bot",text:final});
  localStorage.setItem("nr_assistant_history",JSON.stringify(history));

 }catch{

  addBubble({
   from:"bot",
   text:"âš ï¸ Tidak bisa terhubung ke server."
  });

 }

 stopBtn.classList.add("hidden");
}

/* ===== STOP ===== */

function stopAI(){
 stopBtn.classList.add("hidden");
}

/* ===== VOICE ===== */

function startVoice(){

 if(speaking)return;

 if(!("webkitSpeechRecognition"in window)){
  alert("Voice tidak didukung");
  return;
 }

 const rec=new webkitSpeechRecognition();
 rec.lang="id-ID";
 voiceActive=true;
 rec.start();

 rec.onresult=e=>{
  if(!voiceActive)return;
  input.value=e.results[0][0].transcript;
 };

 rec.onend=()=>voiceActive=false;
}

/* ===== CHIPS ===== */

document.querySelectorAll(".chip").forEach(c=>{
 c.className+=" bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded-full whitespace-nowrap";
 c.onclick=()=>{
  input.value=c.innerText;
  input.focus();
 };
});

input.addEventListener("keydown",e=>{
 if(e.key==="Enter")sendMsg();
});
</script>

</body>
</html>
