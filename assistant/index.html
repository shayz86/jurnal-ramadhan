<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Islamic Assistant</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
body{font-family:system-ui}
</style>
</head>
<body class="bg-slate-100">

<script>
/* ================= PRO GUARD ================= */

if(localStorage.getItem("nr_is_pro")!=="1"){
  alert("Fitur PRO ğŸ”’");
  location.href="/";
}
</script>

<div class="min-h-screen flex flex-col">

<header class="bg-emerald-700 text-white p-4 flex items-center gap-3">
<button onclick="history.back()">â†</button>
<h2 class="font-bold">Smart Islamic Assistant</h2>
</header>

<!-- ============ SESSION MODAL ============ -->

<div id="sessionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">

<div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm space-y-4">

<h3 class="font-bold text-lg">Mulai Percakapan</h3>

<button onclick="resumeChat()"
class="w-full bg-emerald-600 text-white py-3 rounded-xl">
Lanjut Chat Terakhir
</button>

<button onclick="newChat()"
class="w-full border py-3 rounded-xl">
Chat Baru
</button>

</div>
</div>

<!-- ============ CHAT ============ -->

<div id="chatWrap" class="flex-1 overflow-y-auto p-4 space-y-3 hidden"></div>

<!-- ============ QUICK BUTTONS ============ -->

<div class="px-4 pb-2 flex gap-2 overflow-x-auto">
<button onclick="sendQuick('Waktu shalat')" class="bg-emerald-600 text-white px-4 py-2 rounded-full text-xs">ğŸ•Œ Waktu shalat</button>
<button onclick="sendQuick('Doa harian')" class="bg-emerald-600 text-white px-4 py-2 rounded-full text-xs">ğŸ¤² Doa</button>
<button onclick="sendQuick('Puasa sunnah')" class="bg-emerald-600 text-white px-4 py-2 rounded-full text-xs">ğŸŒ™ Puasa</button>
<button onclick="sendQuick('Tafsir ayat')" class="bg-emerald-600 text-white px-4 py-2 rounded-full text-xs">ğŸ“– Tafsir</button>
</div>

<!-- ============ INPUT ============ -->

<div class="bg-white p-3 flex gap-2 items-center border-t">

<button onclick="startVoice()" class="text-xl">ğŸ™ï¸</button>

<input id="input"
placeholder="Tanya tentang ibadah..."
class="flex-1 border rounded-xl px-4 py-2 text-sm">

<button onclick="sendMessage()"
class="bg-emerald-600 text-white px-5 py-2 rounded-xl font-bold">
Kirim
</button>

</div>

</div>

<script>
/* ================= STATE ================= */

const chatWrap=document.getElementById("chatWrap");
const modal=document.getElementById("sessionModal");

let history=JSON.parse(localStorage.getItem("nr_ai_history")||"[]");
let bookmarks=JSON.parse(localStorage.getItem("nr_ai_bookmarks")||"[]");

let recognizing=false;
let recog;

/* ================= SESSION ================= */

if(history.length){
 modal.classList.remove("hidden");
}else{
 modal.classList.add("hidden");
 chatWrap.classList.remove("hidden");
}

function resumeChat(){
 modal.classList.add("hidden");
 chatWrap.classList.remove("hidden");
 renderHistory();
}

function newChat(){
 history=[];
 localStorage.removeItem("nr_ai_history");
 modal.classList.add("hidden");
 chatWrap.classList.remove("hidden");
}

/* ================= RENDER ================= */

function bubble(text,role,id){

 const wrap=document.createElement("div");
 wrap.className=
  role==="user"
   ?"flex justify-end"
   :"flex justify-start";

 const box=document.createElement("div");
 box.className=
  role==="user"
   ?"bg-emerald-600 text-white px-4 py-3 rounded-2xl max-w-[80%]"
   :"bg-white px-4 py-3 rounded-2xl shadow max-w-[80%]";

 box.textContent=text;

 wrap.appendChild(box);

 if(role==="assistant"){

  const tools=document.createElement("div");
  tools.className="flex gap-2 mt-2 text-xs";

  const bm=document.createElement("button");
  bm.textContent="ğŸ”–";
  bm.onclick=()=>bookmark(text);

  const sh=document.createElement("button");
  sh.textContent="ğŸ“¤";
  sh.onclick=()=>share(text);

  box.appendChild(tools);
  tools.append(bm,sh);
 }

 chatWrap.appendChild(wrap);
 chatWrap.scrollTop=999999;
}

/* ================= SEND ================= */

function sendMessage(){
 const input=document.getElementById("input");
 const text=input.value.trim();
 if(!text)return;

 push("user",text);
 input.value="";

 fetchAnswer(text);
}

function sendQuick(t){
 push("user",t);
 fetchAnswer(t);
}

function push(role,text){
 history.push({role,text});
 localStorage.setItem("nr_ai_history",JSON.stringify(history));
 bubble(text,role);
}

/* ================= BACKEND ================= */

async function fetchAnswer(q){

 bubble("â³ Memproses...","assistant");

 try{
  const r=await fetch(
   "https://noorrahma-api.pembang001.workers.dev/assistant/offline",
   {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt:q})
   }
  );

  const d=await r.json();

  chatWrap.lastChild.remove();

  push("assistant",d.answer);

 }catch{
  chatWrap.lastChild.remove();
  push("assistant","âš ï¸ Backend belum aktif.");
 }
}

/* ================= BOOKMARK ================= */

function bookmark(text){
 bookmarks.push({id:Date.now(),text});
 localStorage.setItem("nr_ai_bookmarks",JSON.stringify(bookmarks));
 alert("Disimpan ğŸ‘");
}

/* ================= SHARE ================= */

async function share(text){
 if(navigator.share){
  navigator.share({title:"NoorRahma Assistant",text});
 }else{
  await navigator.clipboard.writeText(text);
  alert("Tersalin");
 }
}

/* ================= VOICE ================= */

function startVoice(){

 if(recognizing)return;

 const SpeechRecognition=
  window.SpeechRecognition||window.webkitSpeechRecognition;

 if(!SpeechRecognition){
  alert("Voice tidak didukung");
  return;
 }

 recog=new SpeechRecognition();
 recog.lang="id-ID";
 recog.interimResults=false;

 recognizing=true;

 recog.start();

 recog.onresult=e=>{
  const t=e.results[0][0].transcript;
  document.getElementById("input").value=t;
 };

 recog.onend=()=>recognizing=false;
}

/* ================= INIT ================= */

function renderHistory(){
 chatWrap.innerHTML="";
 history.forEach(m=>bubble(m.text,m.role));
}

</script>

</body>
</html>
