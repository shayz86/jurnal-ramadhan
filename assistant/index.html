<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Smart Assistant ‚Äî NoorRahma PRO</title>

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config={darkMode:"class"}
</script>

<style>
body{font-family:system-ui}
.chat-scroll::-webkit-scrollbar{display:none}
.ref-box{background:#ecfdf5;border-left:4px solid #10b981}
.dark .ref-box{background:#022c22}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-950">

<!-- ===== PRO GUARD ===== -->
<script>
if(localStorage.getItem("nr_is_pro")!=="1"){
 alert("üîí Fitur khusus akun PRO");
 location.href="/";
}
</script>

<header class="sticky top-0 z-20 bg-emerald-700 text-white p-3 flex items-center gap-3">
<button onclick="history.back()">‚Üê</button>
<h2 class="font-bold">Smart Islamic Assistant</h2>
</header>

<main id="messages"
 class="h-[calc(100vh-190px)] overflow-y-auto p-4 space-y-4 chat-scroll">
</main>

<!-- ===== QUICK CHIPS ===== -->
<div class="px-3 py-2 flex gap-2 overflow-x-auto text-xs bg-white dark:bg-slate-900">
 <button class="chip">üïå Waktu shalat</button>
 <button class="chip">ü§≤ Doa harian</button>
 <button class="chip">üåô Puasa sunnah</button>
 <button class="chip">üìñ Tafsir ayat</button>
</div>

<!-- ===== INPUT BAR ===== -->
<footer class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-3">

<div class="flex gap-2 max-w-md mx-auto">

<button id="micBtn" onclick="startVoice()"
 class="bg-slate-200 px-3 py-3 rounded-xl">üéô</button>

<input id="msgInput"
 type="text"
 placeholder="Tanya tentang ibadah, fiqh, puasa..."
 class="flex-1 border rounded-xl px-4 py-3 text-sm"/>

<button onclick="sendMsg()"
 class="bg-emerald-600 text-white px-5 py-3 rounded-xl font-bold">
Kirim
</button>

<button onclick="stopAI()"
 id="stopBtn"
 class="hidden bg-red-500 text-white px-4 py-3 rounded-xl font-bold">
Stop
</button>

</div>
</footer>

<script>
/* ===================== */
const messages=document.getElementById("messages");
const input=document.getElementById("msgInput");
const stopBtn=document.getElementById("stopBtn");

/* ===== OFFLINE FAQ ===== */

const offlineFAQ=[
 {k:"shalat",v:"Shalat wajib lima waktu: Subuh, Dzuhur, Ashar, Maghrib, Isya."},
 {k:"wudhu",v:"Wudhu: niat, basuh wajah, tangan, usap kepala, kaki, tertib."},
 {k:"puasa",v:"Puasa Ramadhan wajib bagi muslim baligh dan mampu."},
 {k:"zakat",v:"Zakat fitrah dikeluarkan sebelum Idul Fitri."},
 {k:"tayammum",v:"Tayammum dengan debu bersih ketika tidak ada air."},
];

/* ===== HISTORY ===== */

let history=JSON.parse(
 localStorage.getItem("nr_assistant_history")||"[]"
);
history.forEach(addBubble);

/* ===== STREAM CTRL ===== */
let controller=null;

/* ===================== */

function addBubble(msg){

 const div=document.createElement("div");
 div.className=
  (msg.from==="user"
   ?"ml-auto bg-emerald-600 text-white"
   :"mr-auto bg-white dark:bg-slate-800")
  +" max-w-[80%] p-3 rounded-2xl shadow relative";

 div.innerHTML=`<div>${msg.text}</div>`;

 if(msg.refs){
  const r=document.createElement("div");
  r.className="mt-3 p-2 rounded ref-box text-xs";
  r.innerHTML=msg.refs;
  div.appendChild(r);
 }

 if(msg.from==="bot"){
  const speak=document.createElement("button");
  speak.innerText="üîä";
  speak.className="absolute bottom-1 right-2 text-xs opacity-60";
  speak.onclick=()=>speechSynthesis.speak(
   new SpeechSynthesisUtterance(msg.text)
  );
  div.appendChild(speak);
 }

 messages.appendChild(div);
 messages.scrollTop=messages.scrollHeight;
}

/* ===== FALLBACK FAQ ===== */

function searchFAQ(q){
 q=q.toLowerCase();
 for(const f of offlineFAQ){
  if(q.includes(f.k))return f.v;
 }
 return null;
}

/* ===== SEND ===== */

function sendMsg(){

 const text=input.value.trim();
 if(!text)return;

 const obj={from:"user",text,time:Date.now()};
 history.push(obj);
 localStorage.setItem("nr_assistant_history",JSON.stringify(history));
 addBubble(obj);
 input.value="";

 sendToAI(text);
}

/* ===== AI STREAM ===== */

async function sendToAI(text){

 const faq=searchFAQ(text);
 if(!navigator.onLine && faq){
  addBubble({from:"bot",text:faq});
  return;
 }

 controller=new AbortController();
 stopBtn.classList.remove("hidden");

 const bubble=document.createElement("div");
 bubble.className=
  "mr-auto bg-white dark:bg-slate-800 max-w-[80%] p-3 rounded-2xl shadow";

 const body=document.createElement("div");
 bubble.appendChild(body);
 messages.appendChild(bubble);

 try{

  const res=await fetch("/api/assistant",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({prompt:text}),
   signal:controller.signal
  });

  const reader=res.body.getReader();
  const decoder=new TextDecoder();

  let final="";
  let refs="";

  while(true){

   const {value,done}=await reader.read();
   if(done)break;

   const chunk=decoder.decode(value);
   final+=chunk;
   body.innerText=final;

   const ayatMatch=chunk.match(/\[AYAT:(\d+):(\d+)\]/);
   if(ayatMatch){
    loadAyat(ayatMatch[1],ayatMatch[2],bubble);
   }
  }

  history.push({from:"bot",text:final,refs});
  localStorage.setItem("nr_assistant_history",JSON.stringify(history));

 }catch(e){

  const faq=searchFAQ(text);
  addBubble({
   from:"bot",
   text:faq||"‚ö†Ô∏è Offline & tidak ada data lokal."
  });

 }

 stopBtn.classList.add("hidden");
 controller=null;
}

/* ===== AYAT FETCH ===== */

async function loadAyat(s,a,wrap){

 try{
  const r=await fetch(`https://equran.id/api/v2/ayat/${s}/${a}`);
  const d=await r.json();

  const box=document.createElement("div");
  box.className="mt-3 p-3 rounded ref-box text-xs";

  box.innerHTML=
   `<b>QS ${s}:${a}</b><br>
    <div class="text-right text-lg">${d.data.teksArab}</div>
    <div class="italic">${d.data.teksIndonesia}</div>`;

  wrap.appendChild(box);

 }catch{}
}

/* ===== STOP ===== */
function stopAI(){
 if(controller){
  controller.abort();
  controller=null;
 }
 stopBtn.classList.add("hidden");
}

/* ===== VOICE ===== */

function startVoice(){

 if(!("webkitSpeechRecognition"in window)){
  alert("Browser tidak mendukung voice");
  return;
 }

 const rec=new webkitSpeechRecognition();
 rec.lang="id-ID";
 rec.start();

 rec.onresult=e=>{
  input.value=e.results[0][0].transcript;
  sendMsg();
 };
}

/* ===== CHIPS ===== */

document.querySelectorAll(".chip").forEach(c=>{
 c.className+=" bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded-full whitespace-nowrap";
 c.onclick=()=>{
  input.value=c.innerText;
  input.focus();
 };
});

input.addEventListener("keydown",e=>{
 if(e.key==="Enter")sendMsg();
});
</script>

</body>
</html>
