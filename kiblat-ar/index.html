<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>AR Kiblat</title>

<style>
body{margin:0;background:black;color:white;font-family:sans-serif}

video{
 position:fixed;
 inset:0;
 width:100%;
 height:100%;
 object-fit:cover;
}

#overlay{
 position:fixed;
 inset:0;
 display:flex;
 flex-direction:column;
 justify-content:center;
 align-items:center;
 pointer-events:none;
}

.arrow{
 width:10px;
 height:140px;
 background:red;
 border-radius:6px;
 transform-origin:bottom center;
}

.info{
 position:fixed;
 bottom:20px;
 left:50%;
 translate:-50%;
 background:#000a;
 padding:10px 16px;
 border-radius:20px;
 font-size:13px;
}

.back{
 position:fixed;
 top:10px;
 left:10px;
 z-index:9;
 background:#000a;
 border:none;
 color:white;
 padding:8px 14px;
 border-radius:14px;
}
</style>
</head>
<body>

<video id="cam" autoplay playsinline></video>

<div id="overlay">
<div id="arrow" class="arrow"></div>
</div>

<button class="back" onclick="history.back()">←</button>

<div id="info" class="info">Loading...</div>

<script>
/* PRO GUARD */
if(localStorage.getItem("nr_is_pro")!=="1"){
 alert("PRO only");
 location.href="/";
}

const kaaba={lat:21.4225,lon:39.8262};
let qibla=0;
let last=null;

function smooth(a){
 if(last===null){last=a;return a;}
 let d=((a-last+540)%360)-180;
 last=(last+d*0.15+360)%360;
 return last;
}

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>cam.srcObject=s);

navigator.geolocation.getCurrentPosition(pos=>{
 qibla=bearing(
  pos.coords.latitude,
  pos.coords.longitude,
  kaaba.lat,
  kaaba.lon
 );
});

function bearing(lat1,lon1,lat2,lon2){
 const φ1=lat1*Math.PI/180;
 const φ2=lat2*Math.PI/180;
 const dλ=(lon2-lon1)*Math.PI/180;
 return (Math.atan2(
  Math.sin(dλ),
  Math.cos(φ1)*Math.tan(φ2)-Math.sin(φ1)*Math.cos(dλ)
 )*180/Math.PI+360)%360;
}

window.addEventListener("deviceorientation",e=>{
 let heading=null;

 if(e.webkitCompassHeading){
  heading=e.webkitCompassHeading;
 }else if(e.alpha!==null){
  heading=360-e.alpha;
 }

 if(!heading)return;

 const raw=(qibla-heading+360)%360;
 const ang=smooth(raw);

 arrow.style.transform=`rotate(${ang}deg)`;
 info.textContent="Δ "+Math.round(ang)+"°";
});
</script>

</body>
</html>
